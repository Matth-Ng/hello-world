name: Hotfix Deploy to Utility

on:
  pull_request_review:
    types: [submitted]
    branches:
      - hotfix
  workflow_dispatch:

jobs:

  check-workflow:
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest

    steps:
      - name: Get cd-create-prerelease-draft workflow
        id: create-workflow-info
        uses: octokit/request-action@v2.x
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        with:
          route: GET /repos/{repo}/actions/workflows/{workflow_id}
          repo: ${{ github.repository }}
          workflow_id: cd-create-prerelease-draft.yml
      
      - name: Check if create workflow enabled
        id: create-workflow-enabled
        uses: sergeysova/jq-action@v2
        with:
          cmd: |
            echo ${{ steps.create-workflow-info.outputs.data }} | jq '.state'

      - name: Print variable
        run: |
          echo "${{ steps.create-workflow-enabled.outputs.data }}"

  deploy-to-dev:
    if: github.event.review.state == 'approved'
    uses: Matth-Ng/hello-world/.github/workflows/cd-build.yml@hotfix
    
  create-prerelease:
    needs: deploy-to-dev
    uses: Matth-Ng/hello-world/.github/workflows/cd-create-prerelease-draft.yml@hotfix
    secrets: inherit
    with:
      disable-workflow: true
      disable-notes: true

  publish-prerelease:
    needs: create-prerelease
    uses: Matth-Ng/hello-world/.github/workflows/cd-publish-prerelease.yml@hotfix
    with:
      disable-workflow: true
      latest: true
    secrets: inherit

  promote-release:
    needs: publish-prerelease
    uses: Matth-Ng/hello-world/.github/workflows/cd-promote-release.yml@hotfix
    secrets: inherit
    with:
      disable-workflow: true

  enable-normal-workflow:
    runs-on: ubuntu-latest
    needs: promote-release

    steps:
    - name: Enable cd-create-prerelease-draft Workflow
      uses: octokit/request-action@v2.x
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
      with:
        route: PUT /repos/{repo}/actions/workflows/{workflow_id}/enable
        repo: ${{ github.repository }}
        workflow_id: cd-create-prerelease-draft.yml

    - name: Enable cd-publish-prerelease Workflow
      uses: octokit/request-action@v2.x
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
      with:
        route: PUT /repos/{repo}/actions/workflows/{workflow_id}/enable
        repo: ${{ github.repository }}
        workflow_id: cd-publish-prerelease.yml

    - name: Enable cd-promote-release Workflow
      uses: octokit/request-action@v2.x
      env:
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
      with:
        route: PUT /repos/{repo}/actions/workflows/{workflow_id}/enable
        repo: ${{ github.repository }}
        workflow_id: cd-promote-release.yml